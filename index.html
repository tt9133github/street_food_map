<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>street_food_map</title>
  <style>
    :root{
      --border:#e9e9e9;
      --muted:#666;
      --bg:#fff;
      --card:#fafafa;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:var(--bg);}
    .topbar{
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--bg);z-index:10;
    }
    .topbar input,.topbar select{
      padding:8px 10px;border:1px solid #ddd;border-radius:10px;font-size:14px;
      background:#fff;
    }
    .topbar input{flex:1;min-width:140px;}
    .layout{display:grid;grid-template-columns:1fr 360px;height:calc(100% - 54px);}
    #map{height:100%;width:100%;}
    .side{border-left:1px solid var(--border);overflow:auto;background:#fff;}
    .item{padding:10px 12px;border-bottom:1px solid #f2f2f2;cursor:pointer;}
    .item:hover{background:#fafafa;}
    .name{font-weight:700;}
    .meta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.4;}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #eee;border-radius:999px;font-size:12px;margin-left:6px;color:#444;background:#fafafa;}
    .warn{color:#b45309;}
    .err{color:#b91c1c;}

    /* 设置按钮 + 抽屉 */
    .fab{
      position:fixed;right:14px;bottom:14px;z-index:99999;
      width:46px;height:46px;border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(10px);
      box-shadow:0 6px 24px rgba(0,0,0,.14);
      cursor:pointer;font-size:18px;
    }
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.18s ease;z-index:99998;}
    .drawer{
      position:fixed;top:0;right:0;height:100vh;width:min(420px,92vw);
      background:rgba(22,22,24,.96);color:#fff;
      transform:translateX(100%);transition:.18s ease;
      z-index:99999;display:flex;flex-direction:column;
      border-left:1px solid rgba(255,255,255,.12);
    }
    .open .mask{opacity:1;pointer-events:auto;}
    .open .drawer{transform:translateX(0);}
    .drawer-hd{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:space-between;}
    .btn{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;padding:7px 10px;border-radius:12px;
      cursor:pointer;font-size:13px;
    }
    .btn:hover{background:rgba(255,255,255,.14);}
    .btn.danger{border-color:rgba(255,107,107,.45);}
    .btn.primary{border-color:rgba(99,102,241,.55);}
    .drawer-bd{padding:12px 14px;overflow:auto;flex:1;}
    .sec{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:14px;padding:12px;margin-bottom:12px;}
    .sec h3{margin:0 0 8px 0;font-size:14px;}
    .small{font-size:12px;color:rgba(255,255,255,.72);line-height:1.5;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .row input,.row textarea{
      padding:7px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);color:#fff;font-size:13px;
      outline:none;
    }
    .row select{
      padding:7px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);color:#fff;font-size:13px;
      outline:none;
    }
    .row input{flex:1;min-width:180px;}
    .row textarea{width:100%;min-height:140px;resize:vertical;white-space:pre;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
    .split{display:grid;grid-template-columns:1fr;gap:8px;}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);font-size:12px;color:rgba(255,255,255,.85);
    }

    /* 日志：强制深色背景 + 浅色文字，避免白底白字 */
    .logs{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.4;
      background: #0b0b0d !important;
      color: #eaeaea !important;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px;
      height: 34vh;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .logs *{ color: inherit !important; }

    @media (max-width: 920px){
      .layout{grid-template-columns:1fr;}
      .side{height:42vh;border-left:none;border-top:1px solid var(--border);}
      #map{height:calc(58vh - 54px);}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <input id="q" placeholder="搜索（店名/地址/城市）" />
    <select id="cat"></select>
  </div>

  <div class="layout">
    <div id="map"></div>
    <div class="side" id="list"></div>
  </div>

  <button class="fab" id="fab" title="设置 / 管理 / 日志">⚙️</button>
  <div class="mask" id="mask"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <div style="font-weight:700;">设置 / 管理</div>
      <button class="btn" id="close">关闭</button>
    </div>
    <div class="drawer-bd">
      <div class="sec">
        <h3>数据源（Supabase）</h3>
        <div class="small">
          这里请填写 <b>anon public key</b>（可公开）。<br/>
          <span class="warn">不要使用 service_role key</span>（管理员权限，放前端会被盗用）。
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="sbUrl" placeholder="Supabase URL，例如 https://xxxx.supabase.co" />
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="sbAnon" placeholder="Supabase anon public key（eyJ...）" />
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnSaveCfg">保存配置</button>
          <button class="btn" id="btnReload">重新加载数据（覆盖本地）</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnUseLocal">使用本地编辑数据</button>
          <span class="pill" id="dataMode">数据：未知</span>
        </div>
        <div class="small" id="sbHint" style="margin-top:8px;"></div>
      </div>

      <div class="sec">
        <h3>高德地图 Key</h3>
        <div class="small">
          为了避免把 Key 写进仓库，这里运行时加载高德 JS API。<br/>
          填入后保存，然后刷新页面即可。
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="amapKey" placeholder="高德 Web JS API Key" />
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnSaveAmap">保存 Key</button>
          <button class="btn" id="btnReloadMap">重载地图脚本</button>
        </div>
        <div class="small" id="amapHint" style="margin-top:8px;"></div>
      </div>

      <div class="sec" id="secManage">
        <h3>地址管理（新增 / 编辑 / 删除）</h3>
        <div class="small">
          这里的编辑默认写入 <b>本地浏览器存储</b>（localStorage）。<br/>
          你可以用“导出 JSON”把结果复制/下载成 kb.json，然后手动替换仓库静态数据。
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnNew">新增</button>
          <button class="btn" id="btnSaveItem">保存</button>
          <button class="btn" id="btnRelocate">重新定位</button>
          <button class="btn danger" id="btnDelete">删除</button>
        </div>
        <div class="small" id="editHint" style="margin-top:8px;"></div>

        <div class="split" style="margin-top:10px;">
          <div class="row"><input id="fName" placeholder="店名（必填）" /></div>
          <div class="row"><input id="fCategory" placeholder="品类（例如 面 / 中餐）" /></div>
          <div class="row"><input id="fCity" placeholder="城市（例如 成都市）" /></div>
          <div class="row"><input id="fAddress" placeholder="地址（用于定位）" /></div>
          <div class="row" style="gap:8px;">
            <input id="fLng" placeholder="lng 经度（可空，点重新定位可自动填）" />
            <input id="fLat" placeholder="lat 纬度（可空，点重新定位可自动填）" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnExport">导出 JSON（kb.json）</button>
          <button class="btn" id="btnCopyExport">复制 JSON</button>
          <button class="btn danger" id="btnClearLocal">清空本地编辑数据</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <textarea id="exportBox" placeholder="这里会显示导出的 JSON（kb.json 格式）"></textarea>
        </div>
      </div>

      <div class="sec">
        <h3>日志</h3>
        <div class="row" style="margin-bottom:8px;">
          <select id="logLevel">
            <option value="debug">debug</option>
            <option value="info" selected>info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
          <button class="btn" id="btnClearLog">清空</button>
          <button class="btn" id="btnCopyLog">复制</button>
        </div>
        <div class="small">Console 同步输出；这里方便手机端查看。</div>
        <div class="logs" id="logs"></div>
      </div>
    </div>
  </aside>

  <script>
    /**********************
     * 0) 常量
     **********************/
    const CFG_KEY = "sfm_cfg_v1";
    const DB_KEY  = "sfm_db_v1"; // 本地编辑数据（覆盖/保存）

    /**********************
     * 1) 轻量日志系统
     **********************/
    const LogLevel = { debug: 10, info: 20, warn: 30, error: 40 };
    let currentLevel = localStorage.getItem("sfm_log_level") || "info";

    function nowStr(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function errToStr(e){
      try{
        if (!e) return "";
        if (typeof e === "string") return e;
        if (e instanceof Error) return e.stack || e.message;
        return JSON.stringify(e);
      }catch{
        return String(e);
      }
    }
    function log(level, msg, extra){
      if (LogLevel[level] < LogLevel[currentLevel]) return;
      const line = `[${nowStr()}] [${level.toUpperCase()}] ${msg}` + (extra ? ` | ${extra}` : "");
      (console[level] || console.log)(line);
      const el = document.getElementById("logs");
      if (el){
        el.textContent += line + "\\n";
        el.scrollTop = el.scrollHeight;
      }
    }
    window.addEventListener("error", (ev) => log("error", "window.onerror", `${ev.message} @ ${ev.filename}:${ev.lineno}:${ev.colno}`));
    window.addEventListener("unhandledrejection", (ev) => log("error", "unhandledrejection", errToStr(ev.reason)));

    /**********************
     * 2) 设置抽屉
     **********************/
    const body = document.body;
    const drawer = document.getElementById("drawer");
    const fab = document.getElementById("fab");
    const mask = document.getElementById("mask");
    const closeBtn = document.getElementById("close");
    function openDrawer(){ body.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawer(){ body.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }
    fab.addEventListener("click", openDrawer);
    mask.addEventListener("click", closeDrawer);
    closeBtn.addEventListener("click", closeDrawer);

    const logLevelSel = document.getElementById("logLevel");
    logLevelSel.value = currentLevel;
    logLevelSel.addEventListener("change", () => {
      currentLevel = logLevelSel.value;
      localStorage.setItem("sfm_log_level", currentLevel);
      log("info", "日志级别切换", currentLevel);
    });
    document.getElementById("btnClearLog").addEventListener("click", () => {
      document.getElementById("logs").textContent = "";
      log("info", "日志已清空");
    });
    document.getElementById("btnCopyLog").addEventListener("click", async () => {
      const text = document.getElementById("logs").textContent || "";
      try{
        await navigator.clipboard.writeText(text);
        log("info", "日志已复制到剪贴板");
      }catch(e){
        log("warn", "复制失败（浏览器限制）", errToStr(e));
      }
    });

    /**********************
     * 3) 配置（保留默认只读配置 + 本地覆盖）
     **********************/
    // ✅ 给游客用的默认只读配置（写死在代码里）
    const DEFAULT_CFG = {
      supabaseUrl: "https://gwwiwhmryyruyxrmvjbm.supabase.co",
      supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3d2l3aG1yeXlydXl4cm12amJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDA1MDcsImV4cCI6MjA4NjAxNjUwN30.Nl3u335qC5MylCYLjTfTm7vOu4msvl3QjplZuVPqAg4",
      amapKey: "02cb6240c341113e242b757c9c31f120",
      amapSecurityJsCode: "65611fe43ded9c43124b30e1b29cb7ff"
    };

    function loadCfg() {
      try {
        const savedRaw = localStorage.getItem(CFG_KEY);
        const saved = savedRaw ? JSON.parse(savedRaw) : {};
        return { ...DEFAULT_CFG, ...(saved && typeof saved === "object" ? saved : {}) };
      } catch (e) {
        return { ...DEFAULT_CFG };
      }
    }
    function saveCfg(patch){
      const cur = loadCfg();
      const next = { ...cur, ...patch };
      localStorage.setItem(CFG_KEY, JSON.stringify(next));
      return next;
    }

    const sbUrlEl = document.getElementById("sbUrl");
    const sbAnonEl = document.getElementById("sbAnon");
    const sbHintEl = document.getElementById("sbHint");
    const amapKeyEl = document.getElementById("amapKey");
    const amapHintEl = document.getElementById("amapHint");
    const dataModeEl = document.getElementById("dataMode");

    function renderCfgToUI(){
      const cfg = loadCfg();
      sbUrlEl.value = cfg.supabaseUrl || "";
      sbAnonEl.value = cfg.supabaseAnonKey || "";
      amapKeyEl.value = cfg.amapKey || "";
      renderHints();
    }

    function renderHints(){
      const cfg = loadCfg();
      const urlOk = !!cfg.supabaseUrl && cfg.supabaseUrl.includes(".supabase.co");
      const anonOk = !!cfg.supabaseAnonKey && cfg.supabaseAnonKey.startsWith("eyJ");
      sbHintEl.innerHTML =
        `URL：${urlOk ? "OK" : "<span class='err'>缺失/不正确</span>"}；` +
        `anon key：${anonOk ? "OK" : "<span class='err'>请填 anon public key（eyJ...）</span>"}`;
      amapHintEl.innerHTML =
        `高德 Key：${cfg.amapKey ? "已配置" : "<span class='err'>未配置</span>"}`;
    }

    document.getElementById("btnSaveCfg").addEventListener("click", () => {
      const url = (sbUrlEl.value || "").trim();
      const anon = (sbAnonEl.value || "").trim();
      saveCfg({ supabaseUrl: url, supabaseAnonKey: anon });
      renderHints();
      log("info", "Supabase 配置已保存", url);
    });
    document.getElementById("btnSaveAmap").addEventListener("click", () => {
      const key = (amapKeyEl.value || "").trim();
      saveCfg({ amapKey: key });
      renderHints();
      log("info", "高德 Key 已保存");
    });

    /**********************
     * 4) 高德地图：动态加载脚本（AMap v2）
     **********************/
    let map = null;
    let markers = [];
    let amapLoading = null;

    function removeOldAMapScript(){
      const olds = document.querySelectorAll('script[data-amap="1"]');
      olds.forEach(s => s.remove());
      try{ delete window.AMap; }catch{}
      try{ delete window.AMapUI; }catch{}
    }

    async function ensureAMapLoaded(forceReload=false){
      const cfg = loadCfg();
      const key = cfg.amapKey;
      if (!key){
        log("error", "未配置高德 Key，地图无法加载。请在设置中填入。");
        return false;
      }
      if (!forceReload && window.AMap){
        return true;
      }
      if (amapLoading && !forceReload){
        return amapLoading;
      }

      amapLoading = new Promise((resolve) => {
        if (forceReload) removeOldAMapScript();

        log("info", "加载高德地图脚本…");
        const s = document.createElement("script");
        s.dataset.amap = "1";
        s.src = `https://webapi.amap.com/maps?v=2.0&key=${encodeURIComponent(key)}&plugin=AMap.Geocoder`;
        s.async = true;
        s.onload = () => {
          log("info", "高德脚本加载成功");
          resolve(true);
        };
        s.onerror = () => {
          log("error", "高德脚本加载失败（检查 key / 网络 / 域名白名单）");
          resolve(false);
        };
        document.head.appendChild(s);
      });

      return amapLoading;
    }

    function initMap(){
      if (!window.AMap){
        log("error", "AMap 未就绪，initMap 取消");
        return;
      }
      const center = [104.0668, 30.5728];
      map = new AMap.Map("map", {
        zoom: 12,
        center,
        viewMode: "2D"
      });
      log("info", "地图初始化完成", `center=${center.join(",")}`);
    }

    function clearMarkers(){
      if (!map) return;
      for (const m of markers) m.setMap(null);
      markers = [];
    }
    function addMarker(it){
      if (!map) return;
      if (it.lng == null || it.lat == null) return;
      const m = new AMap.Marker({
        position: [it.lng, it.lat],
        title: it.name || "(未命名)"
      });
      m.setMap(map);
      m.on("click", () => {
        const title = (it.name || "(未命名)") + (it.category ? ` / ${it.category}` : "");
        const addr = [it.city, it.address].filter(Boolean).join(" ");
        const html = `<div style="font-size:13px;"><b>${escapeHtml(title)}</b><br/>${escapeHtml(addr)}</div>`;
        const info = new AMap.InfoWindow({ content: html, offset: new AMap.Pixel(0,-30) });
        info.open(map, m.getPosition());
      });
      it.__marker = m;
      markers.push(m);
    }
    function focusItem(it){
      if (!map || !it) return;
      if (it.lng != null && it.lat != null){
        map.setZoomAndCenter(16, [it.lng, it.lat], true);
        if (it.__marker) it.__marker.emit("click", { target: it.__marker });
      }
    }

    /**********************
     * 5) 数据：远程 Supabase REST API（失败回退 kb.json）+ 本地编辑存储
     **********************/
    let allItems = [];
    let selectedId = null;

    function normRow(r){
      return {
        id: String(r.id ?? crypto.randomUUID()),
        name: r.name || "",
        city: r.city || "",
        address: r.address || "",
        category: r.category || "",
        lng: (r.lng === null || r.lng === undefined || r.lng === "") ? null : Number(r.lng),
        lat: (r.lat === null || r.lat === undefined || r.lat === "") ? null : Number(r.lat),
        updatedAt: r.updated_at || null
      };
    }

    function loadLocalDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object" || !Array.isArray(obj.items)) return null;
        const items = obj.items.map(normRowFromLocal);
        return { version: obj.version ?? 1, items };
      }catch{
        return null;
      }
    }
    function normRowFromLocal(r){
      return {
        id: String(r.id ?? crypto.randomUUID()),
        name: r.name || "",
        city: r.city || "",
        address: r.address || "",
        category: r.category || "",
        lng: (r.lng === null || r.lng === undefined || r.lng === "") ? null : Number(r.lng),
        lat: (r.lat === null || r.lat === undefined || r.lat === "") ? null : Number(r.lat),
        updatedAt: r.updatedAt || null
      };
    }
    function saveLocalDB(items, modeLabel){
      const payload = { version: 1, savedAt: new Date().toISOString(), mode: modeLabel || "", items: items.map(it => ({
        id: it.id, name: it.name, city: it.city, address: it.address, category: it.category,
        lng: it.lng, lat: it.lat, updatedAt: it.updatedAt || null
      })) };
      localStorage.setItem(DB_KEY, JSON.stringify(payload));
    }
    function clearLocalDB(){
      localStorage.removeItem(DB_KEY);
    }

    async function loadFromSupabase(){
      const cfg = loadCfg();
      const base = (cfg.supabaseUrl || "").trim();
      const anon = (cfg.supabaseAnonKey || "").trim();

      if (!base || !base.includes(".supabase.co")){
        log("warn", "Supabase URL 未配置/不正确，跳过远程加载");
        return null;
      }
      if (!anon || !anon.startsWith("eyJ")){
        log("warn", "Supabase anon key 未配置/不正确（必须 anon public key: eyJ...），跳过远程加载");
        return null;
      }

      const url = `${base.replace(/\/$/,"")}/rest/v1/places?select=*`;
      log("info", "开始远程拉取 places", url);

      const t0 = performance.now();
      const res = await fetch(url, {
        headers: {
          apikey: anon,
          Authorization: `Bearer ${anon}`
        },
        cache: "no-store"
      }).catch(e => {
        log("error", "fetch 失败", errToStr(e));
        return null;
      });
      if (!res) return null;

      const t1 = performance.now();
      log("info", "远程请求完成", `status=${res.status} cost=${Math.round(t1-t0)}ms`);

      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        log("error", "远程返回非 2xx", txt || `HTTP ${res.status}`);
        return null;
      }

      const data = await res.json().catch(e => {
        log("error", "JSON 解析失败", errToStr(e));
        return null;
      });
      if (!Array.isArray(data)){
        log("error", "远程返回不是数组", JSON.stringify(data).slice(0, 500));
        return null;
      }

      log("info", "远程数据行数", String(data.length));
      return data.map(normRow);
    }

    async function loadFromLocalKb(){
      log("info", "回退读取本地 kb.json");
      try{
        const r = await fetch("./kb.json", { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const kb = await r.json();
        const items = Array.isArray(kb.items) ? kb.items : [];
        const mapped = items.map(it => ({
          id: String(it.id ?? crypto.randomUUID()),
          name: it.name || "",
          city: it.city || "",
          address: it.address || "",
          category: it.category || "",
          lng: it?.location?.lng ?? null,
          lat: it?.location?.lat ?? null,
          updatedAt: it.updatedAt || null
        }));
        log("info", "本地数据行数", String(mapped.length));
        return mapped;
      }catch(e){
        log("error", "本地 kb.json 读取失败", errToStr(e));
        return [];
      }
    }

    function setDataMode(text){
      dataModeEl.textContent = text;
    }

    async function bootLoadData(opts){
      const forceRemote = !!(opts && opts.forceRemote);
      const preferLocal = !!(opts && opts.preferLocal);

      // 1) 先看本地编辑数据
      if (!forceRemote){
        const local = loadLocalDB();
        if (local && Array.isArray(local.items) && local.items.length){
          allItems = local.items;
          setDataMode("数据：本地编辑（已保存）");
          log("info", "使用本地编辑数据", `count=${allItems.length}`);
          renderCat(allItems);
          applyFilter();
          syncEditorSelection(null);
          return;
        }
      }

      // 2) 用户点“使用本地编辑数据”，但本地没有
      if (preferLocal){
        setDataMode("数据：本地编辑（空）");
        log("warn", "本地编辑数据为空：请先重新加载远程或导入静态 kb.json 再编辑");
      }

      // 3) 远程优先，失败回退 kb.json
      const remote = await loadFromSupabase();
      allItems = remote || await loadFromLocalKb();

      // 4) 保存为本地编辑基线（覆盖旧本地）
      saveLocalDB(allItems, remote ? "supabase" : "kb.json");
      setDataMode(remote ? "数据：Supabase（已拉取→已缓存本地）" : "数据：kb.json（已缓存本地）");

      renderCat(allItems);
      applyFilter();
      syncEditorSelection(null);
    }

    /**********************
     * 6) UI：列表/过滤/渲染
     **********************/
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderCat(items){
      const sel = document.getElementById("cat");
      const counts = new Map();
      for (const it of items || []) {
        const c = (it.category || "").trim();
        if (!c) continue;
        counts.set(c, (counts.get(c) || 0) + 1);
      }
      const cats = Array.from(counts.entries())
        .sort((a, b) => (b[1] - a[1]) || a[0].localeCompare(b[0], "zh"));
      sel.innerHTML =
        `<option value="">全部品类 (${items?.length || 0})</option>` +
        cats.map(([c, n]) => `<option value="${escapeHtml(c)}">${escapeHtml(c)} (${n})</option>`).join("");
    }

    function renderList(items){
      const list = document.getElementById("list");
      if (!items.length){
        list.innerHTML = `<div class="item"><div class="name">没有数据</div><div class="meta">请检查设置里的 Supabase Key / RLS / 网络</div></div>`;
        return;
      }
      list.innerHTML = items.map(it => {
        const title = escapeHtml(it.name || "(未命名)");
        const cat = it.category ? `<span class="badge">${escapeHtml(it.category)}</span>` : "";
        const addr = escapeHtml([it.city, it.address].filter(Boolean).join(" ")) || "(无地址)";
        const loc = (it.lng != null && it.lat != null) ? `${Number(it.lng).toFixed(6)}, ${Number(it.lat).toFixed(6)}` : "<span class='warn'>无坐标</span>";
        const active = (String(it.id) === String(selectedId)) ? " style='background:#f7f7ff;'" : "";
        return `
          <div class="item" data-id="${escapeHtml(it.id)}"${active}>
            <div class="name">${title}${cat}</div>
            <div class="meta">${addr}<br/>${loc}</div>
          </div>
        `;
      }).join("");

      list.querySelectorAll(".item").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const it = allItems.find(x => String(x.id) === String(id));
          if (!it){
            log("warn", "点击项不存在", id);
            return;
          }
          selectedId = String(it.id);
          syncEditorSelection(selectedId);
          renderList(applyFilter({silent:true}));
          focusItem(it);
          log("info", "定位到条目", `${it.id} ${it.name}`);
        });
      });
    }

    function applyFilter(opts){
      const silent = !!(opts && opts.silent);
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const cat = (document.getElementById("cat").value || "").trim();

      const filtered = allItems.filter(it => {
        if (cat && it.category !== cat) return false;
        if (!q) return true;
        const hay = `${it.name} ${it.city} ${it.address} ${it.category}`.toLowerCase();
        return hay.includes(q);
      });

      clearMarkers();
      for (const it of filtered) addMarker(it);
      renderList(filtered);

      if (!silent){
        log("debug", "过滤完成", `q="${q}", cat="${cat}", count=${filtered.length}`);
      }
      return filtered;
    }

    document.getElementById("q").addEventListener("input", () => {
      clearTimeout(window.__sfm_q_t);
      window.__sfm_q_t = setTimeout(() => applyFilter(), 120);
    });
    document.getElementById("cat").addEventListener("change", () => applyFilter());

    /**********************
     * 7) 管理面板：新增/编辑/删除/重新定位/导出 JSON
     **********************/
    const fName = document.getElementById("fName");
    const fCategory = document.getElementById("fCategory");
    const fCity = document.getElementById("fCity");
    const fAddress = document.getElementById("fAddress");
    const fLng = document.getElementById("fLng");
    const fLat = document.getElementById("fLat");
    const editHint = document.getElementById("editHint");
    const exportBox = document.getElementById("exportBox");

    function setEditHint(html){
      editHint.innerHTML = html || "";
    }

    function getEditingItemFromForm(){
      return {
        name: (fName.value || "").trim(),
        category: (fCategory.value || "").trim(),
        city: (fCity.value || "").trim(),
        address: (fAddress.value || "").trim(),
        lng: (fLng.value || "").trim(),
        lat: (fLat.value || "").trim()
      };
    }
    function setFormFromItem(it){
      fName.value = it?.name || "";
      fCategory.value = it?.category || "";
      fCity.value = it?.city || "";
      fAddress.value = it?.address || "";
      fLng.value = (it?.lng == null ? "" : String(it.lng));
      fLat.value = (it?.lat == null ? "" : String(it.lat));
    }

    function syncEditorSelection(id){
      selectedId = id ? String(id) : null;
      const it = selectedId ? allItems.find(x => String(x.id) === String(selectedId)) : null;
      if (it){
        setFormFromItem(it);
        setEditHint(`当前编辑：<b>${escapeHtml(it.name || "(未命名)")}</b>（id=${escapeHtml(it.id)}）`);
      }else{
        setFormFromItem({name:"",category:"",city:"",address:"",lng:"",lat:""});
        setEditHint("当前编辑：<span class='warn'>未选择</span>（点列表条目进入编辑，或点“新增”）");
      }
    }

    function upsertLocalAndRerender(){
      saveLocalDB(allItems, "edited");
      renderCat(allItems);
      applyFilter();
    }

    document.getElementById("btnNew").addEventListener("click", () => {
      selectedId = null;
      syncEditorSelection(null);
      setEditHint("新增模式：填写后点“保存”");
      fName.focus();
    });

    document.getElementById("btnSaveItem").addEventListener("click", () => {
      const form = getEditingItemFromForm();
      if (!form.name){
        setEditHint("<span class='err'>店名必填</span>");
        log("warn", "保存失败：店名必填");
        return;
      }
      const lng = form.lng === "" ? null : Number(form.lng);
      const lat = form.lat === "" ? null : Number(form.lat);
      if ((form.lng !== "" && Number.isNaN(lng)) || (form.lat !== "" && Number.isNaN(lat))){
        setEditHint("<span class='err'>lng/lat 必须是数字或留空</span>");
        log("warn", "保存失败：lng/lat 非数字");
        return;
      }

      if (selectedId){
        const idx = allItems.findIndex(x => String(x.id) === String(selectedId));
        if (idx < 0){
          setEditHint("<span class='err'>未找到要编辑的条目</span>");
          return;
        }
        allItems[idx] = { ...allItems[idx],
          name: form.name, category: form.category, city: form.city, address: form.address,
          lng, lat, updatedAt: new Date().toISOString()
        };
        log("info", "已保存编辑", `${allItems[idx].id} ${allItems[idx].name}`);
      }else{
        const it = {
          id: crypto.randomUUID(),
          name: form.name, category: form.category, city: form.city, address: form.address,
          lng, lat, updatedAt: new Date().toISOString()
        };
        allItems.unshift(it);
        selectedId = String(it.id);
        log("info", "已新增条目", `${it.id} ${it.name}`);
      }

      upsertLocalAndRerender();
      syncEditorSelection(selectedId);

      const it2 = selectedId ? allItems.find(x => String(x.id) === String(selectedId)) : null;
      if (it2) focusItem(it2);
    });

    document.getElementById("btnDelete").addEventListener("click", () => {
      if (!selectedId){
        setEditHint("<span class='warn'>未选择条目，无法删除</span>");
        return;
      }
      const it = allItems.find(x => String(x.id) === String(selectedId));
      if (!it) return;

      const ok = confirm(`确认删除：${it.name || "(未命名)"} ?`);
      if (!ok) return;

      allItems = allItems.filter(x => String(x.id) !== String(selectedId));
      log("warn", "已删除条目", `${selectedId}`);
      selectedId = null;
      upsertLocalAndRerender();
      syncEditorSelection(null);
    });

    async function geocodeAddress(fullAddr){
      if (!window.AMap) throw new Error("AMap 未就绪");
      return new Promise((resolve, reject) => {
        try{
          const geocoder = new AMap.Geocoder({ city: "全国" });
          geocoder.getLocation(fullAddr, (status, result) => {
            if (status === "complete" && result && result.geocodes && result.geocodes.length){
              const loc = result.geocodes[0].location;
              resolve({ lng: loc.lng, lat: loc.lat });
            }else{
              reject(new Error("地理编码失败：" + (result?.info || status || "unknown")));
            }
          });
        }catch(e){
          reject(e);
        }
      });
    }

    document.getElementById("btnRelocate").addEventListener("click", async () => {
      try{
        if (!selectedId){
          setEditHint("<span class='warn'>请先在列表选择一条，再重新定位</span>");
          return;
        }
        const idx = allItems.findIndex(x => String(x.id) === String(selectedId));
        if (idx < 0){
          setEditHint("<span class='err'>未找到该条目</span>");
          return;
        }
        const it = allItems[idx];
        const addr = [it.city, it.address].filter(Boolean).join(" ").trim();
        if (!addr){
          setEditHint("<span class='err'>城市/地址为空，无法定位</span>");
          return;
        }
        if (!window.AMap){
          setEditHint("<span class='err'>地图未加载（AMap 未就绪）</span>");
          return;
        }

        setEditHint("正在定位…");
        const loc = await geocodeAddress(addr);
        allItems[idx] = { ...it, lng: loc.lng, lat: loc.lat, updatedAt: new Date().toISOString() };
        upsertLocalAndRerender();
        syncEditorSelection(selectedId);
        const it2 = allItems[idx];
        focusItem(it2);
        log("info", "重新定位成功", `${it2.name} @ ${loc.lng},${loc.lat}`);
        setEditHint(`重新定位成功：<b>${escapeHtml(it2.name)}</b>`);
      }catch(e){
        log("error", "重新定位失败", errToStr(e));
        setEditHint(`<span class='err'>重新定位失败</span>：${escapeHtml(errToStr(e)).slice(0,200)}`);
      }
    });

    function toKbJson(items){
      return {
        version: 1,
        items: (items || []).map(it => ({
          id: it.id,
          name: it.name || "",
          city: it.city || "",
          address: it.address || "",
          category: it.category || "",
          location: (it.lng != null && it.lat != null) ? { lng: Number(it.lng), lat: Number(it.lat) } : null
        }))
      };
    }

    function refreshExportBox(){
      const kb = toKbJson(allItems);
      exportBox.value = JSON.stringify(kb, null, 2);
      return exportBox.value;
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnExport").addEventListener("click", () => {
      const text = refreshExportBox();
      downloadText("kb.json", text);
      log("info", "已导出 kb.json（下载）");
    });
    document.getElementById("btnCopyExport").addEventListener("click", async () => {
      const text = refreshExportBox();
      try{
        await navigator.clipboard.writeText(text);
        log("info", "已复制导出 JSON");
        setEditHint("已复制导出 JSON（可直接替换仓库 kb.json）");
      }catch(e){
        log("warn", "复制导出 JSON 失败（浏览器限制）", errToStr(e));
        setEditHint("<span class='warn'>复制失败（浏览器限制）</span>：你可以手动选中下方文本复制");
      }
    });

    document.getElementById("btnClearLocal").addEventListener("click", () => {
      const ok = confirm("确认清空本地编辑数据？清空后将回到远程/静态数据。");
      if (!ok) return;
      clearLocalDB();
      selectedId = null;
      exportBox.value = "";
      log("warn", "已清空本地编辑数据");
      bootLoadData({ forceRemote: true });
    });

    /**********************
     * 8) 其它按钮：重新加载 / 强制本地
     **********************/
    document.getElementById("btnReload").addEventListener("click", () => {
      closeDrawer();
      bootLoadData({ forceRemote: true });
    });
    document.getElementById("btnUseLocal").addEventListener("click", () => {
      closeDrawer();
      bootLoadData({ preferLocal: true });
    });
    document.getElementById("btnReloadMap").addEventListener("click", async () => {
      closeDrawer();
      const ok = await ensureAMapLoaded(true);
      if (ok){
        initMap();
        applyFilter();
      }
    });

    /**********************
     * 9) 启动
     **********************/
    (async function main(){
      renderCfgToUI();
      renderHints();

      log("info", "页面启动");

      const ok = await ensureAMapLoaded(false);
      if (ok){
        initMap();
      }else{
        log("warn", "地图未加载成功，但列表仍可用。请在设置中检查高德 Key。");
      }

      await bootLoadData({ forceRemote: false });
      syncEditorSelection(null);
      refreshExportBox();
    })();
  </script>
</body>
</html>

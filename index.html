<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>street_food_map</title>

  <!-- Leaflet（不需要地图 key，GitHub Pages 直接可用） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; }

    .topbar{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-bottom:1px solid #e8e8e8;
      position: sticky; top: 0; background: #fff; z-index: 10;
    }
    .topbar input, .topbar select{
      padding:8px 10px; border:1px solid #ddd; border-radius:10px;
      font-size:14px;
    }
    .topbar input{ flex: 1; min-width: 120px; }
    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      height: calc(100% - 54px);
    }
    #map{ height: 100%; }
    .side{
      border-left:1px solid #eee;
      overflow:auto;
    }
    .item{
      padding:10px 12px;
      border-bottom:1px solid #f0f0f0;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .name{ font-weight: 700; }
    .meta{ font-size: 12px; color:#666; margin-top:4px; line-height:1.4; }
    .badge{
      display:inline-block; padding:2px 8px; border:1px solid #eee; border-radius:999px;
      font-size:12px; margin-left:6px; color:#444; background:#fafafa;
    }

    /* ===== 设置按钮 + 抽屉 ===== */
    .fab{
      position: fixed; right: 14px; bottom: 14px; z-index: 99999;
      width: 46px; height: 46px; border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 24px rgba(0,0,0,.14);
      cursor:pointer;
      font-size:18px;
    }
    .mask{
      position:fixed; inset:0; background: rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition: .18s ease; z-index: 99998;
    }
    .drawer{
      position:fixed; top:0; right:0; height:100vh; width:min(420px, 92vw);
      background: rgba(22,22,24,.96); color:#fff;
      transform: translateX(100%); transition: .18s ease;
      z-index: 99999; display:flex; flex-direction:column;
      border-left: 1px solid rgba(255,255,255,.12);
    }
    .open .mask{ opacity:1; pointer-events:auto; }
    .open .drawer{ transform: translateX(0); }

    .drawer-hd{
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between;
    }
    .btn{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff; padding:7px 10px; border-radius:12px;
      cursor:pointer; font-size:13px;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .drawer-bd{ padding: 12px 14px; overflow:auto; flex:1; }
    .sec{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius:14px; padding:12px; margin-bottom:12px;
    }
    .sec h3{ margin:0 0 8px 0; font-size:14px; }
    .small{ font-size:12px; color: rgba(255,255,255,.72); line-height:1.5; }
    .logs{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; line-height:1.4;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px;
      height: 46vh;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row select{ padding:7px 9px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.10); color:#fff; }
    .kv{ font-size:12px; color: rgba(255,255,255,.78); line-height:1.5; }
    @media (max-width: 920px){
      .layout{ grid-template-columns: 1fr; }
      .side{ height: 42vh; border-left:none; border-top:1px solid #eee; }
      #map{ height: calc(58vh - 54px); }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <input id="q" placeholder="搜索（店名/地址/城市）" />
    <select id="cat"></select>
  </div>

  <div class="layout">
    <div id="map"></div>
    <div class="side" id="list"></div>
  </div>

  <button class="fab" id="fab" title="设置 / 日志">⚙️</button>
  <div class="mask" id="mask"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-hd">
      <div style="font-weight:700;">设置</div>
      <button class="btn" id="close">关闭</button>
    </div>
    <div class="drawer-bd">
      <div class="sec">
        <h3>日志</h3>
        <div class="row" style="margin-bottom:8px;">
          <select id="logLevel">
            <option value="debug">debug</option>
            <option value="info" selected>info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
          <button class="btn" id="btnClearLog">清空</button>
          <button class="btn" id="btnCopyLog">复制</button>
        </div>
        <div class="small">Console 也会同步输出；这里方便在手机上直接看。</div>
        <div class="logs" id="logs"></div>
      </div>

      <div class="sec">
        <h3>数据源</h3>
        <div class="small">
          当前使用 Supabase REST API 拉取 places 表数据。<br/>
          ⚠️ 请使用 <b>anon public key</b>，不要把 service_role key 放到前端（会被任何人盗用）。
        </div>
        <div class="kv" id="diag"></div>
      </div>
    </div>
  </aside>

  <script>
    /**********************
     * 0) 配置：务必使用 anon key
     **********************/
    const SUPABASE_PROJECT_REF = "gwwiwhmryyruyxrmvjbm";
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_REF}.supabase.co`;
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3d2l3aG1yeXlydXl4cm12amJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDA1MDcsImV4cCI6MjA4NjAxNjUwN30.Nl3u335qC5MylCYLjTfTm7vOu4msvl3QjplZuVPqAg4";

    const API_PLACES = `${SUPABASE_URL}/rest/v1/places?select=*`;

    /**********************
     * 1) 日志系统（可在设置里查看）
     **********************/
    const LogLevel = { debug: 10, info: 20, warn: 30, error: 40 };
    let currentLevel = localStorage.getItem("sfm_log_level") || "info";
    const logsEl = () => document.getElementById("logs");

    function nowStr(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function log(level, msg, extra){
      if (LogLevel[level] < LogLevel[currentLevel]) return;
      const line = `[${nowStr()}] [${level.toUpperCase()}] ${msg}` + (extra ? ` | ${extra}` : "");
      // console
      const fn = console[level] || console.log;
      fn(line);
      // panel
      const el = logsEl();
      if (el){
        el.textContent += line + "\n";
        el.scrollTop = el.scrollHeight;
      }
    }
    function errToStr(e){
      try{
        if (!e) return "";
        if (typeof e === "string") return e;
        if (e instanceof Error) return e.stack || e.message;
        return JSON.stringify(e);
      }catch{
        return String(e);
      }
    }

    window.addEventListener("error", (ev) => {
      log("error", "window.onerror", `${ev.message} @ ${ev.filename}:${ev.lineno}:${ev.colno}`);
    });
    window.addEventListener("unhandledrejection", (ev) => {
      log("error", "unhandledrejection", errToStr(ev.reason));
    });

    /**********************
     * 2) 设置抽屉
     **********************/
    const body = document.body;
    const fab = document.getElementById("fab");
    const mask = document.getElementById("mask");
    const drawer = document.getElementById("drawer");
    const closeBtn = document.getElementById("close");

    function openDrawer(){ body.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawer(){ body.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }

    fab.addEventListener("click", openDrawer);
    mask.addEventListener("click", closeDrawer);
    closeBtn.addEventListener("click", closeDrawer);

    const logLevelSel = document.getElementById("logLevel");
    logLevelSel.value = currentLevel;
    logLevelSel.addEventListener("change", () => {
      currentLevel = logLevelSel.value;
      localStorage.setItem("sfm_log_level", currentLevel);
      log("info", "日志级别已切换", currentLevel);
    });

    document.getElementById("btnClearLog").addEventListener("click", () => {
      logsEl().textContent = "";
      log("info", "日志已清空");
    });
    document.getElementById("btnCopyLog").addEventListener("click", async () => {
      const text = logsEl().textContent || "";
      try{
        await navigator.clipboard.writeText(text);
        log("info", "日志已复制到剪贴板");
      }catch(e){
        log("warn", "复制失败（可能是浏览器限制）", errToStr(e));
      }
    });

    function renderDiag(){
      const el = document.getElementById("diag");
      el.innerHTML = `
        <div>API: ${API_PLACES}</div>
        <div>Key: ${SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith("eyJ") ? "anon key 已配置" : "未配置 / 不是 anon key"}</div>
        <div>提示：如果你把 service_role key 放前端，请立刻 Rotate。</div>
      `;
    }

    /**********************
     * 3) 地图 + 渲染
     **********************/
    let map, markersLayer;
    let allItems = [];

    function initMap(){
      map = L.map("map", { zoomControl: true });
      // 默认成都（你也可以改）
      map.setView([30.5728, 104.0668], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      log("info", "地图初始化完成");
    }

    function clearMarkers(){
      markersLayer.clearLayers();
    }

    function addMarker(it){
      if (!it || it.lat == null || it.lng == null) return;
      const m = L.marker([it.lat, it.lng]);
      const title = (it.name || "(未命名)") + (it.category ? ` / ${it.category}` : "");
      const addr = [it.city, it.address].filter(Boolean).join(" ");
      m.bindPopup(`<b>${escapeHtml(title)}</b><br/>${escapeHtml(addr)}`);
      m.addTo(markersLayer);
      it.__marker = m;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function normRow(r){
      // 你现在 DB 字段：id,name,city,address,category,lng,lat,updated_at
      return {
        id: r.id,
        name: r.name || "",
        city: r.city || "",
        address: r.address || "",
        category: r.category || "",
        lng: (r.lng === null || r.lng === undefined) ? null : Number(r.lng),
        lat: (r.lat === null || r.lat === undefined) ? null : Number(r.lat),
        updatedAt: r.updated_at || r.updatedAt || null
      };
    }

    function renderCat(items){
      const sel = document.getElementById("cat");
      const cats = Array.from(new Set(items.map(x => (x.category || "").trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">全部品类</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function renderList(items){
      const list = document.getElementById("list");
      if (!items.length){
        list.innerHTML = `<div class="item"><div class="name">没有数据</div><div class="meta">请检查 API key / RLS / 网络</div></div>`;
        return;
      }
      list.innerHTML = items.map(it => {
        const title = escapeHtml(it.name || "(未命名)");
        const cat = it.category ? `<span class="badge">${escapeHtml(it.category)}</span>` : "";
        const addr = escapeHtml([it.city, it.address].filter(Boolean).join(" "));
        const loc = (it.lng != null && it.lat != null) ? `${it.lng.toFixed(6)}, ${it.lat.toFixed(6)}` : "无坐标";
        return `
          <div class="item" data-id="${escapeHtml(it.id)}">
            <div class="name">${title}${cat}</div>
            <div class="meta">${addr || "(无地址)"}<br/>${loc}</div>
          </div>
        `;
      }).join("");

      list.querySelectorAll(".item").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const it = allItems.find(x => String(x.id) === String(id));
          if (it && it.lat != null && it.lng != null){
            map.setView([it.lat, it.lng], 16, { animate: true });
            if (it.__marker) it.__marker.openPopup();
            log("info", "定位到条目", `${it.id} ${it.name}`);
          } else {
            log("warn", "该条目无坐标，无法定位", `${it?.id} ${it?.name}`);
          }
        });
      });
    }

    function applyFilter(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const cat = (document.getElementById("cat").value || "").trim();

      const filtered = allItems.filter(it => {
        if (cat && it.category !== cat) return false;
        if (!q) return true;
        const hay = `${it.name} ${it.city} ${it.address} ${it.category}`.toLowerCase();
        return hay.includes(q);
      });

      clearMarkers();
      for (const it of filtered) addMarker(it);
      renderList(filtered);

      log("debug", "过滤完成", `q="${q}", cat="${cat}", count=${filtered.length}`);
    }

    document.getElementById("q").addEventListener("input", () => {
      // 简单防抖
      clearTimeout(window.__sfm_q_t);
      window.__sfm_q_t = setTimeout(applyFilter, 120);
    });
    document.getElementById("cat").addEventListener("change", applyFilter);

    /**********************
     * 4) 远程读取：Supabase REST API
     **********************/
    async function loadFromRemote(){
      log("info", "开始读取远程数据", API_PLACES);

      if (!SUPABASE_ANON_KEY || !SUPABASE_ANON_KEY.startsWith("eyJ")) {
        log("error", "未配置 anon public key（必须是 eyJ...）");
        return [];
      }

      const t0 = performance.now();
      const res = await fetch(API_PLACES, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        },
        cache: "no-store"
      });

      const t1 = performance.now();
      log("info", "远程请求完成", `status=${res.status} cost=${Math.round(t1 - t0)}ms`);

      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        log("error", "远程请求失败", txt || `HTTP ${res.status}`);
        return [];
      }

      const data = await res.json();
      if (!Array.isArray(data)){
        log("error", "返回不是数组（检查 API / 表名）", JSON.stringify(data).slice(0, 300));
        return [];
      }

      log("info", "远程数据解析成功", `rows=${data.length}`);
      return data.map(normRow);
    }

    /**********************
     * 5) 启动
     **********************/
    (async function main(){
      renderDiag();
      initMap();

      try{
        allItems = await loadFromRemote();
        renderCat(allItems);
        applyFilter();
      }catch(e){
        log("error", "初始化失败", errToStr(e));
      }
    })();
  </script>
</body>
</html>

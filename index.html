<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Street Food Map (Debug)</title>

  <!-- Leaflet (no API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111824;
      --muted:#9bb0c6;
      --text:#e8f0ff;
      --line:#243246;
      --ok:#39d98a;
      --warn:#ffcc00;
      --err:#ff5d5d;
      --btn:#1e2a3d;
      --btn2:#243246;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    header .title{
      font-weight:700;
      letter-spacing:.2px;
      margin-right:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }
    header .pill{
      font-size:12px;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
    }
    .btn{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
    }
    .btn:hover{ background:var(--btn2); }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{ border-color: rgba(255,93,93,.5); }
    .btn.ok{ border-color: rgba(57,217,138,.5); }
    input[type="file"]{ display:none; }

    .layout{
      display:grid;
      grid-template-columns: 1fr 380px;
      height: calc(100vh - 58px);
      min-height: 520px;
    }
    #map{
      width:100%;
      height:100%;
    }
    .side{
      border-left:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,36,.95), rgba(17,24,36,.80));
      display:flex;
      flex-direction:column;
      min-width: 320px;
    }
    .panel{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 0 0 auto; }

    select, input[type="text"]{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:14px;
      outline:none;
      width: 100%;
    }
    .row .w50{ width: calc(50% - 4px); }
    .row .w100{ width: 100%; }

    .list{
      overflow:auto;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(30,42,61,.45);
    }
    .card h3{
      margin:0 0 4px 0;
      font-size:15px;
      line-height:1.2;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .small{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      word-break:break-word;
    }
    .tag{
      font-size:12px;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
    }
    .actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .logbox{
      border-top:1px solid var(--line);
      padding:10px 12px;
      height: 38%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .loghead{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .loghead .left{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .loghead .right{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .logs{
      flex:1;
      overflow:auto;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
    }

    @media (max-width: 920px){
      .layout{ grid-template-columns: 1fr; }
      .side{
        height: 55vh;
        border-left:none;
        border-top:1px solid var(--line);
      }
      .logbox{ height: 42%; }
    }
  </style>
</head>

<body>
<header>
  <div class="title">ğŸœ Street Food Map <span class="pill">Debug Build</span></div>

  <label class="btn ok" for="fileImport">å¯¼å…¥ JSON</label>
  <input id="fileImport" type="file" accept=".json,application/json" />

  <button class="btn" id="btnReload">é‡æ–°åŠ è½½ kb.json</button>
  <button class="btn" id="btnExport">å¯¼å‡ºå½“å‰æ•°æ®</button>
  <button class="btn danger" id="btnReset">æ¸…ç©ºæœ¬åœ°ç¼“å­˜</button>
</header>

<div class="layout">
  <div id="map"></div>

  <aside class="side">
    <div class="panel">
      <div class="row">
        <select id="catFilter" class="w50" title="æŒ‰å“ç±»è¿‡æ»¤"></select>
        <input id="qFilter" class="w50" type="text" placeholder="æœç´¢ï¼šåº—å/åœ°å€/åŸå¸‚" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnFit">ç¼©æ”¾åˆ°å…¨éƒ¨ç‚¹</button>
        <button class="btn" id="btnDiag">è¾“å‡ºè¯Šæ–­æ‘˜è¦</button>
      </div>
      <div class="small" style="margin-top:8px">
        æ•°æ®æºä¼˜å…ˆçº§ï¼š<b>localStorage</b>ï¼ˆæœ‰åˆ™ç”¨ï¼‰â†’ å¦åˆ™åŠ è½½åŒç›®å½• <b>kb.json</b>ã€‚<br/>
        æ²¡æœ‰ <span class="mono">location{lng,lat}</span> çš„æ¡ç›®ä¼šè¢«è·³è¿‡å¹¶è®°å½•åŸå› ã€‚
      </div>
    </div>

    <div class="list" id="list"></div>

    <div class="logbox">
      <div class="loghead">
        <div class="left">
          <span class="tag">Logs</span>
          <span class="small" id="logStat">0 lines</span>
        </div>
        <div class="right">
          <select id="logLevel" title="æ—¥å¿—çº§åˆ«">
            <option value="debug">debug</option>
            <option value="info" selected>info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
          <button class="btn" id="btnClearLogs">æ¸…ç©ºæ—¥å¿—</button>
        </div>
      </div>
      <div class="logs mono" id="logs"></div>
    </div>
  </aside>
</div>

<script>
/** =========================
 *  0) Logger: console + UI
 *  ========================= */
const Logger = (() => {
  const levelRank = { debug: 10, info: 20, warn: 30, error: 40 };
  let currentLevel = "info";
  const lines = [];
  const el = () => document.getElementById("logs");
  const stat = () => document.getElementById("logStat");

  function setLevel(lv){
    currentLevel = lv;
    info("logger.level", { level: lv });
  }
  function shouldLog(lv){
    return levelRank[lv] >= levelRank[currentLevel];
  }
  function fmtTime(d){
    const pad = n => String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}.${String(d.getMilliseconds()).padStart(3,"0")}`;
  }
  function safeJson(x){
    try { return JSON.stringify(x); }
    catch { return String(x); }
  }
  function push(lv, tag, data){
    if (!shouldLog(lv)) return;
    const t = fmtTime(new Date());
    const msg = data === undefined ? "" : ` ${safeJson(data)}`;
    const line = `[${t}] ${lv.toUpperCase()} ${tag}${msg}`;
    lines.push(line);
    // UI
    const box = el();
    if (box){
      box.textContent = lines.join("\n");
      box.scrollTop = box.scrollHeight;
    }
    if (stat()){
      stat().textContent = `${lines.length} lines`;
    }
    // console
    const fn = (lv === "debug") ? console.debug :
               (lv === "info")  ? console.info  :
               (lv === "warn")  ? console.warn  : console.error;
    fn(line);
  }
  function debug(tag, data){ push("debug", tag, data); }
  function info(tag, data){ push("info", tag, data); }
  function warn(tag, data){ push("warn", tag, data); }
  function error(tag, data){ push("error", tag, data); }
  function clear(){
    lines.length = 0;
    if (el()) el().textContent = "";
    if (stat()) stat().textContent = "0 lines";
    console.clear();
    info("logger.cleared");
  }
  function snapshot(){
    return lines.slice();
  }

  return { setLevel, debug, info, warn, error, clear, snapshot };
})();

// Global error hooks
window.addEventListener("error", (e) => {
  Logger.error("window.onerror", {
    message: e.message,
    filename: e.filename,
    lineno: e.lineno,
    colno: e.colno,
    error: e.error ? String(e.error) : undefined
  });
});
window.addEventListener("unhandledrejection", (e) => {
  Logger.error("unhandledrejection", {
    reason: e.reason ? (e.reason.stack || String(e.reason)) : "unknown"
  });
});

// Log level UI
document.getElementById("logLevel").addEventListener("change", (e) => {
  Logger.setLevel(e.target.value);
});

/** =========================
 *  1) Utilities
 *  ========================= */
const now = () => performance.now();
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const uid = () => (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2)));

function isObject(x){ return x && typeof x === "object" && !Array.isArray(x); }
function toNum(x){
  const n = typeof x === "number" ? x : Number(x);
  return Number.isFinite(n) ? n : null;
}

function validateKB(raw){
  // è¿”å› {ok, value, issues[]}
  const issues = [];
  if (!isObject(raw)) {
    issues.push("root ä¸æ˜¯ object");
    return { ok:false, value:{version:1, items:[]}, issues };
  }
  const version = toNum(raw.version) ?? 1;
  const items = Array.isArray(raw.items) ? raw.items : [];
  if (!Array.isArray(raw.items)) issues.push("root.items ä¸æ˜¯æ•°ç»„ï¼Œå·²å½“ä½œç©ºæ•°ç»„å¤„ç†");

  const norm = [];
  for (let i=0;i<items.length;i++){
    const it = items[i];
    if (!isObject(it)){
      issues.push(`items[${i}] ä¸æ˜¯ objectï¼Œå·²è·³è¿‡`);
      continue;
    }
    const id = (it.id && String(it.id).trim()) || uid();
    const name = (it.name && String(it.name).trim()) || "";
    const city = (it.city && String(it.city).trim()) || "";
    const address = (it.address && String(it.address).trim()) || "";
    const category = (it.category && String(it.category).trim()) || "æœªåˆ†ç±»";

    let lng = null, lat = null;
    if (isObject(it.location)){
      lng = toNum(it.location.lng);
      lat = toNum(it.location.lat);
    }
    const hasLoc = (lng !== null && lat !== null);

    norm.push({
      id, name, city, address, category,
      location: hasLoc ? { lng, lat } : null
    });

    if (!name) issues.push(`items[${i}] ç¼º nameï¼ˆid=${id}ï¼‰`);
    if (!address) issues.push(`items[${i}] ç¼º addressï¼ˆid=${id}ï¼‰`);
    if (!hasLoc) issues.push(`items[${i}] ç¼º location{lng,lat}ï¼ˆid=${id}ï¼‰ -> åˆå§‹åŒ–ä¸ä¼šç”»ç‚¹`);
  }

  return { ok:true, value:{ version, items:norm }, issues };
}

function storageGet(key){
  try{
    const s = localStorage.getItem(key);
    Logger.debug("storage.get", { key, bytes: s ? s.length : 0 });
    return s;
  }catch(e){
    Logger.error("storage.get.fail", { key, error: String(e) });
    return null;
  }
}
function storageSet(key, val){
  try{
    localStorage.setItem(key, val);
    Logger.debug("storage.set", { key, bytes: val.length });
    return true;
  }catch(e){
    Logger.error("storage.set.fail", { key, error: String(e) });
    return false;
  }
}
function storageRemove(key){
  try{
    localStorage.removeItem(key);
    Logger.debug("storage.remove", { key });
    return true;
  }catch(e){
    Logger.error("storage.remove.fail", { key, error: String(e) });
    return false;
  }
}

async function fetchJson(url){
  const t0 = now();
  Logger.info("fetch.start", { url });
  let resp;
  try{
    resp = await fetch(url, { cache: "no-store" });
  }catch(e){
    Logger.error("fetch.network_error", { url, error: String(e) });
    throw e;
  }
  Logger.info("fetch.response", { url, status: resp.status, ok: resp.ok, ms: Math.round(now()-t0) });

  const ct = resp.headers.get("content-type") || "";
  Logger.debug("fetch.content_type", { url, contentType: ct });

  const text = await resp.text();
  Logger.debug("fetch.body_peek", {
    url,
    bytes: text.length,
    head: text.slice(0, 120) + (text.length > 120 ? "..." : "")
  });

  // å¸¸è§ï¼šè¿”å›äº† HTMLï¼ˆ404 é¡µé¢ï¼‰å¯¼è‡´ JSON parse å¤±è´¥
  if (text.trim().startsWith("<")) {
    Logger.warn("fetch.suspect_html", { url, hint: "å“åº”çœ‹èµ·æ¥åƒ HTMLï¼ˆå¯èƒ½æ˜¯ 404 æˆ– GitHub Pages è·¯å¾„é—®é¢˜ï¼‰" });
  }

  try{
    const json = JSON.parse(text);
    Logger.info("fetch.json_parsed", { url, ms: Math.round(now()-t0) });
    return json;
  }catch(e){
    Logger.error("fetch.json_parse_error", { url, error: String(e) });
    throw e;
  }
}

/** =========================
 *  2) App State
 *  ========================= */
const APP = {
  STORAGE_KEY: "street_food_map_kb_v1",
  kb: { version: 1, items: [] },
  map: null,
  markers: new Map(), // id -> L.Marker
  filter: {
    category: "å…¨éƒ¨",
    q: ""
  },
  diag: {
    lastLoadSource: null,
    lastLoadMs: 0,
    lastRenderMs: 0,
    skippedNoLocation: 0,
    renderedMarkers: 0
  }
};

/** =========================
 *  3) Map init + marker ops
 *  ========================= */
function initMap(){
  const t0 = now();
  Logger.info("map.init.start");

  // Default center: Chengdu
  const center = [30.5728, 104.0668];
  const zoom = 12;

  const map = L.map("map", {
    zoomControl: true,
    preferCanvas: true
  }).setView(center, zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  map.on("click", (e) => {
    Logger.debug("map.click", { lat: e.latlng.lat, lng: e.latlng.lng });
  });
  map.on("load", () => Logger.debug("map.load"));
  map.on("moveend", () => Logger.debug("map.moveend", { center: map.getCenter(), zoom: map.getZoom() }));

  APP.map = map;
  Logger.info("map.init.done", { ms: Math.round(now()-t0), center, zoom });
}

function clearMarkers(){
  const t0 = now();
  const n = APP.markers.size;
  for (const [id, m] of APP.markers.entries()){
    try { m.remove(); } catch {}
    APP.markers.delete(id);
  }
  Logger.info("markers.cleared", { count: n, ms: Math.round(now()-t0) });
}

function addMarker(item){
  if (!APP.map){
    Logger.error("marker.add.fail_no_map", { id: item?.id });
    return null;
  }
  if (!item.location){
    Logger.warn("marker.add.skip_no_location", { id: item.id, name: item.name });
    return null;
  }

  const { lat, lng } = item.location;
  const marker = L.marker([lat, lng], { title: item.name || item.address || item.id });
  marker.addTo(APP.map);

  const html = `
    <div style="min-width:220px">
      <div style="font-weight:700;margin-bottom:4px">${escapeHtml(item.name || "(æ— åº—å)")}</div>
      <div style="font-size:12px;color:#666;margin-bottom:6px">${escapeHtml(item.category || "")}</div>
      <div style="font-size:12px">${escapeHtml(item.city || "")} ${escapeHtml(item.address || "")}</div>
      <div style="font-size:12px;margin-top:6px;color:#666" class="mono">${lng}, ${lat}</div>
    </div>
  `;
  marker.bindPopup(html);

  marker.on("click", () => Logger.debug("marker.click", { id: item.id }));
  APP.markers.set(item.id, marker);
  return marker;
}

function fitAll(){
  if (!APP.map) return;
  const pts = [];
  for (const it of APP.kb.items){
    if (it.location) pts.push([it.location.lat, it.location.lng]);
  }
  if (!pts.length){
    Logger.warn("map.fit.skip", { reason: "æ²¡æœ‰ä»»ä½•å¸¦ç»çº¬åº¦çš„æ¡ç›®" });
    return;
  }
  const bounds = L.latLngBounds(pts);
  APP.map.fitBounds(bounds.pad(0.12));
  Logger.info("map.fit", { points: pts.length });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/** =========================
 *  4) UI: filter + list
 *  ========================= */
function computeCategories(items){
  const set = new Set();
  for (const it of items){
    set.add((it.category || "æœªåˆ†ç±»").trim() || "æœªåˆ†ç±»");
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b,"zh"));
}

function renderCatFilter(){
  const el = document.getElementById("catFilter");
  const cats = computeCategories(APP.kb.items);
  const all = ["å…¨éƒ¨", ...cats];

  const old = el.value;
  el.innerHTML = "";
  for (const c of all){
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    el.appendChild(opt);
  }
  // try keep selection
  el.value = all.includes(old) ? old : "å…¨éƒ¨";
  APP.filter.category = el.value;

  Logger.info("ui.catFilter.rendered", { options: all.length, selected: el.value });
}

function applyFilter(items){
  const { category, q } = APP.filter;
  const qq = (q || "").trim().toLowerCase();

  let out = items;
  if (category && category !== "å…¨éƒ¨"){
    out = out.filter(it => (it.category || "æœªåˆ†ç±»") === category);
  }
  if (qq){
    out = out.filter(it => {
      const blob = `${it.name||""} ${it.city||""} ${it.address||""} ${it.category||""}`.toLowerCase();
      return blob.includes(qq);
    });
  }
  return out;
}

function renderList(items){
  const list = document.getElementById("list");
  list.innerHTML = "";

  if (!items.length){
    const empty = document.createElement("div");
    empty.className = "card";
    empty.innerHTML = `<div class="small">æ²¡æœ‰åŒ¹é…ç»“æœã€‚å¯å°è¯•æ¸…ç©ºç­›é€‰ï¼Œæˆ–æ£€æŸ¥æ˜¯å¦æœ‰ç»çº¬åº¦ locationã€‚</div>`;
    list.appendChild(empty);
    return;
  }

  for (const it of items){
    const card = document.createElement("div");
    card.className = "card";

    const loc = it.location ? `${it.location.lng}, ${it.location.lat}` : "æ— ç»çº¬åº¦ï¼ˆä¸ä¼šåœ¨åœ°å›¾æ˜¾ç¤ºï¼‰";
    card.innerHTML = `
      <h3>
        <span>${escapeHtml(it.name || "(æ— åº—å)")}</span>
        <span class="tag">${escapeHtml(it.category || "æœªåˆ†ç±»")}</span>
      </h3>
      <div class="small">${escapeHtml(it.city || "")} ${escapeHtml(it.address || "")}</div>
      <div class="small mono" style="margin-top:6px">${escapeHtml(loc)}</div>
      <div class="actions">
        <button class="btn" data-act="locate" data-id="${escapeHtml(it.id)}">å®šä½</button>
        <button class="btn" data-act="edit" data-id="${escapeHtml(it.id)}">ç¼–è¾‘</button>
      </div>
    `;
    list.appendChild(card);
  }

  list.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if (act === "locate") locateItem(id);
      if (act === "edit") editItem(id);
    });
  });
}

function locateItem(id){
  const it = APP.kb.items.find(x => x.id === id);
  if (!it){
    Logger.warn("ui.locate.not_found", { id });
    return;
  }
  if (!it.location){
    Logger.warn("ui.locate.no_location", { id, name: it.name });
    return;
  }
  const { lat, lng } = it.location;
  APP.map.setView([lat, lng], Math.max(APP.map.getZoom(), 16), { animate: true });
  const mk = APP.markers.get(id);
  if (mk) mk.openPopup();
  Logger.info("ui.locate", { id, lat, lng });
}

function editItem(id){
  const it = APP.kb.items.find(x => x.id === id);
  if (!it){
    Logger.warn("ui.edit.not_found", { id });
    return;
  }

  const name = prompt("åº—å", it.name || "");
  if (name === null) return;

  const category = prompt("å“ç±»", it.category || "æœªåˆ†ç±»");
  if (category === null) return;

  const city = prompt("åŸå¸‚", it.city || "");
  if (city === null) return;

  const address = prompt("åœ°å€", it.address || "");
  if (address === null) return;

  let lng = it.location?.lng ?? "";
  let lat = it.location?.lat ?? "";
  const lngStr = prompt("ç»åº¦ lngï¼ˆç•™ç©º=æ— ç»çº¬åº¦ï¼‰", lng);
  if (lngStr === null) return;
  const latStr = prompt("çº¬åº¦ latï¼ˆç•™ç©º=æ— ç»çº¬åº¦ï¼‰", lat);
  if (latStr === null) return;

  const nlng = lngStr.trim() ? toNum(lngStr.trim()) : null;
  const nlat = latStr.trim() ? toNum(latStr.trim()) : null;
  if ((lngStr.trim() && nlng === null) || (latStr.trim() && nlat === null)){
    Logger.warn("ui.edit.invalid_location", { id, lngStr, latStr });
    alert("ç»çº¬åº¦æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¿…é¡»æ˜¯æ•°å­—ï¼‰ã€‚å·²å–æ¶ˆä¿å­˜ã€‚");
    return;
  }

  it.name = name.trim();
  it.category = category.trim() || "æœªåˆ†ç±»";
  it.city = city.trim();
  it.address = address.trim();
  it.location = (nlng !== null && nlat !== null) ? { lng: nlng, lat: nlat } : null;

  persistKB("editItem");
  renderAll("editItem");

  Logger.info("ui.edit.saved", { id, hasLocation: !!it.location });
}

/** =========================
 *  5) Core render pipeline
 *  ========================= */
function renderAll(reason){
  const t0 = now();
  Logger.info("renderAll.start", {
    reason,
    totalItems: APP.kb.items.length,
    filter: APP.filter
  });

  // 1) build filtered
  const filtered = applyFilter(APP.kb.items);

  // 2) markers
  clearMarkers();
  let rendered = 0;
  let skippedNoLoc = 0;

  for (const it of filtered){
    if (!it.location){
      skippedNoLoc++;
      Logger.debug("render.skip_no_location", { id: it.id, name: it.name, address: it.address });
      continue;
    }
    try{
      const m = addMarker(it);
      if (m) rendered++;
    }catch(e){
      Logger.error("render.marker_error", { id: it.id, error: String(e) });
    }
  }

  // 3) list
  renderList(filtered);

  APP.diag.lastRenderMs = Math.round(now()-t0);
  APP.diag.skippedNoLocation = skippedNoLoc;
  APP.diag.renderedMarkers = rendered;

  Logger.info("renderAll.done", {
    ms: APP.diag.lastRenderMs,
    filtered: filtered.length,
    renderedMarkers: rendered,
    skippedNoLocation: skippedNoLoc
  });
}

/** =========================
 *  6) Data load / persist
 *  ========================= */
function persistKB(reason){
  const t0 = now();
  const text = JSON.stringify(APP.kb, null, 2);
  const ok = storageSet(APP.STORAGE_KEY, text);
  Logger.info("kb.persist", { ok, reason, ms: Math.round(now()-t0), items: APP.kb.items.length });
}

function loadFromStorage(){
  const t0 = now();
  const s = storageGet(APP.STORAGE_KEY);
  if (!s){
    Logger.info("kb.storage.miss");
    return null;
  }
  try{
    const raw = JSON.parse(s);
    const v = validateKB(raw);
    Logger.info("kb.storage.parsed", { ok: v.ok, issues: v.issues.length, ms: Math.round(now()-t0) });
    if (v.issues.length) Logger.warn("kb.storage.issues", { issues: v.issues.slice(0, 12) });
    return v.value;
  }catch(e){
    Logger.error("kb.storage.parse_fail", { error: String(e) });
    return null;
  }
}

async function loadFromKbJson(){
  const t0 = now();
  const raw = await fetchJson("./kb.json"); // åŒç›®å½•
  const v = validateKB(raw);
  Logger.info("kb.kbjson.validated", { ok: v.ok, issues: v.issues.length, ms: Math.round(now()-t0) });
  if (v.issues.length) Logger.warn("kb.kbjson.issues", { issues: v.issues.slice(0, 12) });
  return v.value;
}

async function loadKB(){
  const t0 = now();
  Logger.info("kb.load.start");

  // 1) storage first
  const fromStore = loadFromStorage();
  if (fromStore){
    APP.kb = fromStore;
    APP.diag.lastLoadSource = "localStorage";
    APP.diag.lastLoadMs = Math.round(now()-t0);
    Logger.info("kb.load.done", { source: "localStorage", ms: APP.diag.lastLoadMs, items: APP.kb.items.length });
    return;
  }

  // 2) fetch kb.json
  try{
    const fromFile = await loadFromKbJson();
    APP.kb = fromFile;
    APP.diag.lastLoadSource = "kb.json";
    APP.diag.lastLoadMs = Math.round(now()-t0);
    Logger.info("kb.load.done", { source: "kb.json", ms: APP.diag.lastLoadMs, items: APP.kb.items.length });
  }catch(e){
    APP.kb = { version: 1, items: [] };
    APP.diag.lastLoadSource = "failed";
    APP.diag.lastLoadMs = Math.round(now()-t0);
    Logger.error("kb.load.fail", { ms: APP.diag.lastLoadMs, error: String(e) });
  }
}

/** =========================
 *  7) Import / Export
 *  ========================= */
document.getElementById("fileImport").addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  e.target.value = "";
  if (!f) return;

  Logger.info("import.start", { name: f.name, size: f.size, type: f.type });

  let text;
  try{
    text = await f.text();
    Logger.debug("import.text_peek", { head: text.slice(0, 120) + (text.length>120?"...":"") });
  }catch(err){
    Logger.error("import.read_fail", { error: String(err) });
    alert("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
    return;
  }

  let raw;
  try{
    raw = JSON.parse(text);
  }catch(err){
    Logger.error("import.json_parse_fail", { error: String(err) });
    alert("JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ã€‚");
    return;
  }

  const v = validateKB(raw);
  Logger.info("import.validated", { ok: v.ok, issues: v.issues.length });
  if (v.issues.length) Logger.warn("import.issues", { issues: v.issues.slice(0, 20) });

  APP.kb = v.value;
  persistKB("import");
  renderCatFilter();
  renderAll("import");
  fitAll();
});

document.getElementById("btnExport").addEventListener("click", () => {
  const t0 = now();
  const text = JSON.stringify(APP.kb, null, 2);
  const blob = new Blob([text], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kb_export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  Logger.info("export.done", { bytes: text.length, ms: Math.round(now()-t0) });
});

document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("ç¡®è®¤æ¸…ç©ºæœ¬åœ°ç¼“å­˜ï¼ˆlocalStorageï¼‰ï¼Ÿæ¸…ç©ºåå°†é‡æ–°ä» kb.json åŠ è½½ã€‚")) return;
  storageRemove(APP.STORAGE_KEY);
  Logger.warn("storage.reset");
  location.reload();
});

document.getElementById("btnReload").addEventListener("click", async () => {
  Logger.info("reload.clicked");
  await loadKB();
  renderCatFilter();
  renderAll("reload");
  fitAll();
});

document.getElementById("btnFit").addEventListener("click", fitAll);

document.getElementById("btnClearLogs").addEventListener("click", () => Logger.clear());

document.getElementById("catFilter").addEventListener("change", (e) => {
  APP.filter.category = e.target.value;
  Logger.info("filter.category", { value: APP.filter.category });
  renderAll("filter.category");
});

document.getElementById("qFilter").addEventListener("input", (e) => {
  APP.filter.q = e.target.value;
  Logger.debug("filter.q", { value: APP.filter.q });
  renderAll("filter.q");
});

document.getElementById("btnDiag").addEventListener("click", () => {
  const diag = {
    time: new Date().toISOString(),
    page: location.href,
    protocol: location.protocol,
    lastLoadSource: APP.diag.lastLoadSource,
    lastLoadMs: APP.diag.lastLoadMs,
    lastRenderMs: APP.diag.lastRenderMs,
    totalItems: APP.kb.items.length,
    renderedMarkers: APP.diag.renderedMarkers,
    skippedNoLocation: APP.diag.skippedNoLocation,
    filter: APP.filter
  };
  Logger.info("diag.summary", diag);

  // é¢å¤–ï¼šæç¤ºæœ€å¸¸è§é—®é¢˜
  const hints = [];
  if (location.protocol === "file:") {
    hints.push("ä½ æ˜¯ç”¨ file:// æ‰“å¼€çš„ï¼Œfetch(kb.json) åœ¨å¾ˆå¤šæµè§ˆå™¨ä¼šå¤±è´¥ã€‚è¯·ç”¨æœ¬åœ°é™æ€æœåŠ¡å™¨ã€‚");
  }
  if (APP.kb.items.length && APP.diag.renderedMarkers === 0) {
    hints.push("æ•°æ®æœ‰æ¡ç›®ä½†æ¸²æŸ“ 0 ä¸ª markerï¼šé€šå¸¸æ˜¯ items å…¨éƒ¨ç¼º location{lng,lat}ï¼Œæˆ–è¢«ç­›é€‰æ¡ä»¶è¿‡æ»¤æ‰ã€‚è¯·çœ‹æ—¥å¿—ä¸­çš„ render.skip_no_location / filterã€‚");
  }
  if (!APP.kb.items.length) {
    hints.push("å½“å‰ items=0ï¼šå¯èƒ½ kb.json æ²¡åŠ è½½åˆ°ï¼ˆ404/è·¯å¾„é—®é¢˜ï¼‰ï¼Œæˆ– localStorage é‡Œæ˜¯ç©ºæ•°æ®ã€‚çœ‹ fetch.* æ—¥å¿—å³å¯å®šä½ã€‚");
  }
  if (hints.length) Logger.warn("diag.hints", { hints });

  alert(
    "è¯Šæ–­æ‘˜è¦å·²è¾“å‡ºåˆ°æ—¥å¿—é¢æ¿ï¼ˆLogsï¼‰å’Œæ§åˆ¶å° Consoleã€‚\n\n" +
    hints.map((x,i)=>`${i+1}. ${x}`).join("\n")
  );
});

/** =========================
 *  8) Boot
 *  ========================= */
(async () => {
  Logger.info("boot.start", {
    href: location.href,
    protocol: location.protocol,
    userAgent: navigator.userAgent
  });

  // åˆå§‹åŒ–åœ°å›¾
  try{
    initMap();
  }catch(e){
    Logger.error("boot.map_init_fail", { error: String(e) });
  }

  // åŠ è½½æ•°æ®
  try{
    await loadKB();
  }catch(e){
    Logger.error("boot.loadKB_fail", { error: String(e) });
  }

  // æ¸²æŸ“ UI
  try{
    renderCatFilter();
    renderAll("boot");
    // ç¨å¾®å»¶è¿Ÿ fitï¼Œç¡®ä¿ map å·² ready
    await sleep(30);
    fitAll();
  }catch(e){
    Logger.error("boot.render_fail", { error: String(e) });
  }

  Logger.info("boot.done");
})();
</script>
</body>
</html>
